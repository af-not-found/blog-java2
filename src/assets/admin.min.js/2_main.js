/*!
 * blog.afnf.net
 */

afnfblog.entry_changed = false;

afnfblog.delayedTids = {};

afnfblog.delayedExec = function(func, delay) {
	var tid = afnfblog.delayedTids[func];
	if (tid) {
		clearTimeout(tid);
	}
	afnfblog.delayedTids[func] = setTimeout(func, delay);
};

afnfblog.update_preview = function() {

	afnfblog.admin_entry_state_changed(true);

	var f = function() {
		var e = $('.textarea_entry');
		if (e.size() > 0) {
			var plain = e.val();
			var html = marked(plain);
			$('.entry_content').html(html);
			$('#contentHtml').val(html);
			afnfblog.highlight();
		}

		if (afnfblog.isMobile == false) {
			var hc = $(".entry_content").height();
			var viewportHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
			var hw = viewportHeight * 0.6;
			e.height(hc > hw ? hc : hw);
		}
	};

	if (afnfblog.isMobile) {
		afnfblog.delayedExec(f, 2000);
	} else {
		afnfblog.delayedExec(f, 300);
	}
};

afnfblog.admin_entry_init = function(btn_selector) {
	$(btn_selector).removeClass("btn-default").addClass("btn-primary");

	var e = $('.textarea_entry');
	if (e.size() > 0) {
		$(".entry_edit_form_div").on("keyup", ".textarea_entry", afnfblog.update_preview);
		$(".entry_edit_parent_div").on("click", ".btn_width", function() {
			var e = $(this);
			$(".btn_width").removeClass("btn-primary");
			e.addClass("btn-primary");
			var w = e.text();
			$(".preview_container").css("width", w);
		});
		afnfblog.update_preview();
		afnfblog.admin_entry_state_changed(false);
	}

	$(document).on("change", "input", function() {
		afnfblog.admin_entry_state_changed(true);
	});

	$(window).on("beforeunload", function(e) {
		if (afnfblog.entry_changed) {
			return t("blog.leave_confirmation");
		}
	});
};

afnfblog.admin_comment_init = function() {
	$(".btn_comments").removeClass("btn-default").addClass("btn-primary");
	$(".comments_container").on("click", ".shortened_comment", function(e) {
		$(this).removeClass("shortened_comment");
	});
	$(".comments_container").on("click", ".stateRadio", function(e) {
		$(this).parent("form").submit();
	});
};

afnfblog.ajaxSuccess = function(thisform, data) {

	var e = $('.textarea_entry');
	if (e.size() > 0) {
		afnfblog.admin_entry_state_changed(false);
		// 新規登録後に採番IDを反映
		$(".entry_edit_form_div #id").val(data.id);
	}

	var e = thisform.find(".ajaxret");
	e.text(t("blog.update_ok"));
	setTimeout(function() {
		e.text("");
	}, 3000);
};

afnfblog.admin_entry_state_changed = function(changed) {
	if (changed == false || afnfblog.entry_changed != changed) {
		afnfblog.entry_changed = changed;
		$("#submit_btn").prop("disabled", changed == false);
	}
};
