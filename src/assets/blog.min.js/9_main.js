/*!
 * blog.afnf.net
 */

var afnfblog = {};

afnfblog.loading = true;

afnfblog.isMobile = false;

afnfblog.bindform = function() {

	$(".validate").validate();

	$('.ajaxform').submit(function() {
		var thisform = $(this);

		if (thisform.attr("class").toString().indexOf("validate") != -1) {
			if (thisform.valid() == false) {
				return false;
			}
		}

		thisform.find(':submit').prop("disabled", true);
		var enable = function() {
			thisform.find(':submit').prop("disabled", false);
			afnfblog.loading = false;
		};

		afnfblog.loading = true;

		$.ajax({
			type : "POST",
			cache : false,
			dataType : "json",
			url : afnfblog.contextRoot + "token",
			success : function(data, textStatus, xhr) {

				var token = data.token;
				if (afnfblog.convToken) {
					token = afnfblog.convToken(token);
				}

				thisform.ajaxSubmit({
					dataType : "json",
					headers : {
						"X-FORM-TOKEN" : token
					},
					data : {
						post : true
					},
					success : function(data, textStatus, xhr) {
						enable();
						if (data.demoSite) {
							afnfblog.alert(t("blog.demo_error"));
						} else {
							if (afnfblog.ajaxSuccess) {
								afnfblog.ajaxSuccess(thisform, data);
							}
						}
					},
					error : function(xhr, textStatus) {
						afnfblog.alert(t("blog.update_error", textStatus));
						enable();
					}
				});
			},
			error : function(responseText, statusText) {
				afnfblog.alert(t("blog.comm_error", statusText));
				enable();
			}
		});

		return false;
	});
};

afnfblog.highlight = function() {
	if (hljs) {
		$('.entry_content code').each(function(i, e) {
			hljs.highlightBlock(e);
		});
	}
};

afnfblog.pagenator = function() {

	var totalPageCount = afnfblog.totalPageCount;
	var thisPage = afnfblog.thisPage;

	var pe = $(".pagination");
	if (pe.size() == 0) {
		return;
	}

	pe.on("click", "li.disabled a", function() {
		return false;
	});
	pe.on("click", "li.active a", function() {
		return false;
	});

	var width = $(window).width();
	var pageCount = 11;
	if (width >= 640) {
		pageCount = 15;
	} else if (width >= 420) {
		pageCount = 13;
	}

	var padCount = pageCount - 9;
	var header = false, footer = false;
	var begin, end;
	if (totalPageCount <= pageCount - 2) {
		begin = 1;
		end = totalPageCount;
	} else if ((padCount + 2) <= thisPage && thisPage <= totalPageCount - (padCount + 2)) {
		header = true;
		footer = true;
		begin = thisPage - padCount;
		end = thisPage + padCount;
	} else if (thisPage < (padCount + 2)) {
		footer = true;
		begin = 1;
		end = padCount * 2 + 2;
	} else {
		header = true;
		begin = totalPageCount - (padCount * 2 + 1);
		end = totalPageCount;
	}

	var path = afnfblog.contextRoot + afnfblog.pagingPath;

	var clazz = (thisPage == 1) ? "disabled" : "normal";
	var s = '<li class="' + clazz + '"><a href="' + path + (thisPage - 1) + '">&lt;</a></li>';

	if (header) {
		s += '<li class="disabled hellip"><a href="#">&hellip;</a></li>';
	}
	for (var index = begin; index <= end; index++) {
		clazz = "normal";
		if (thisPage == index) {
			clazz += " active";
		}
		s += '<li class="' + clazz + '"><a href="' + (path + index) + '">' + index + '</a></li>';
	}
	if (footer) {
		s += '<li class="disabled hellip"><a href="#">&hellip;</a></li>';
	}

	clazz = (thisPage == totalPageCount) ? "disabled" : "normal";
	s += '<li class="' + clazz + '"><a href="' + path + (thisPage + 1) + '">&gt;</a></li>';

	pe.append(s);
};

afnfblog.alert = function(text, callback) {

	if (afnfblog.isMobile) {
		alert(text);
		callback();
	} else {
		$("#alert_text").text(text);
		$("#alert_modal").leanModal({
			callback : callback
		});
		$("#close_modal").text(t("blog.close"));
	}
};

afnfblog.reloadPage = function() {
	afnfblog.loading = true;
	location.reload(false);
};

afnfblog.movePage = function(href) {
	afnfblog.loading = true;
	location.href = href;
};

afnfblog.expand = function(atag) {
	var parent = $(atag).parent();
	parent.prev().removeClass("sb_clop");
	parent.remove();
	return false;
};

x18n.register('ja', {
	blog : {
		wait : '(承認待ち)',
		yourname : 'お名前',
		comments : 'コメント',
		demo_error : 'デモサイトは更新できません',
		comm_error : '通信エラー : %1',
		update_error : '更新エラー : %1',
		comment_ok : 'コメントありがとうございました',
		update_ok : "更新成功",
		reg_admin : "管理者を登録してください",
		login_failed : "ログインできません",
		leave_confirmation : "未保存の変更があります。",
		submit : "送信",
		cancel : "キャンセル",
		close : "閉じる",
		matched : "該当",
		demo_password : "デモサイトはid=admin, password=passでログインできます"
	},
	validation : {
		required : "必須",
		maxlength : "最大{0}文字",
		minlength : "最小{0}文字"
	}
});

x18n.register('en', {
	blog : {
		wait : '(waiting for approval)',
		yourname : 'your name',
		comments : 'comments',
		demo_error : 'Updates prohibited in the demo site',
		comm_error : 'communication error : %1',
		update_error : 'update error : %1',
		comment_ok : 'Thank you for your comment',
		update_ok : "update succeeded",
		reg_admin : "register administrator",
		login_failed : "login failed",
		leave_confirmation : "You have unsaved changes.",
		submit : "submit",
		cancel : "cancel",
		close : "close",
		matched : "matched",
		demo_password : "You can login id=admin, password=pass in the demo site"
	},
	validation : {
		required : "required",
		maxlength : "max {0}chars",
		minlength : "min {0}chars"
	}
});

$(document).ready(function() {

	if (afnfblog.pagingPath === undefined) {
		afnfblog.pagingPath = "?page=";
	}

	var ua = navigator.userAgent;
	if (/(iPhone|iPod|iPad|Android|BlackBerry|mobile)/i.test(ua)) {
		afnfblog.isMobile = true;
	}

	x18n.setDefault('ja');
	// IEだと自動検出がうまくいかない？firefox以外はOS言語になる
	var lang = x18n.detectLocal().substr(0, 2);
	x18n.set(lang);

	// jQuery.validatorメッセージのカスタマイズ
	var m = $.validator.messages;
	m.required = t("validation.required");
	m.maxlength = $.validator.format(t("validation.maxlength"));
	m.minlength = $.validator.format(t("validation.minlength"));

	afnfblog.loading = false;

	// 遅延させないとwindow sizeが取れない模様
	setTimeout(afnfblog.pagenator, 30);
	afnfblog.highlight();
	afnfblog.bindform();
});
